<template>
  <div class="mb-14">
    <div class="tt-illustration">
      <svg
        version="1.1"
        viewBox="0 0 240.24 331.91"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g transform="translate(30.918 91.87)">
          <g transform="matrix(.35278 0 0 -.35278 81.308 239.92)">
            <path
              d="m0 0s-337.08 361.02-316.73 610.23c0 0 12.662 302.65 326.05 329.68 0 0 315.9 14.831 353.06-329.68"
              fill="#2374ab"
              stroke="#2374ab"
              stroke-miterlimit="10"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 81.065 238.72)">
            <path
              d="m0 0s369.05 321.87 362.86 606.68"
              stroke="#2374ab"
              stroke-miterlimit="10"
              fill="#2374ab"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 -3.5304 31.257)">
            <path
              d="m0 0c0 147.51 117.93 267.09 263.4 267.09s263.4-119.58 263.4-267.09c0-147.51-117.93-267.09-263.4-267.09s-263.4 119.58-263.4 267.09"
              fill="#eef6fc"
            />
            <path
              d="m0 0c0 147.51 117.93 267.09 263.4 267.09s263.4-119.58 263.4-267.09c0-147.51-117.93-267.09-263.4-267.09s-263.4 119.58-263.4 267.09z"
              fill="none"
              stroke="#eef6fc"
              stroke-miterlimit="10"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 -12.639 31.152)">
            <path
              d="m0 0c0 161.79 129.34 292.94 288.89 292.94 159.55 0 288.89-131.15 288.89-292.94 0-161.79-129.34-292.94-288.89-292.94-159.55 0-288.89 131.15-288.89 292.94z"
              fill="none"
              stroke="#eef6fc"
              stroke-miterlimit="10"
              stroke-width="5"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 144.97 87.604)">
            <path
              d="m0 0-1.695 326c-0.07 13.466-11.354 24.335-25.222 24.294l-264-0.778c-16.413-0.048-29.71-12.951-29.772-28.89l-1.251-320.62c-0.048-12.446 10.348-22.549 23.164-22.512l276.61 0.807c12.293 0.036 22.222 9.755 22.16 21.693"
              fill="#2374ab"
            />
            <path
              d="m0 0-1.695 326c-0.07 13.466-11.354 24.335-25.222 24.294l-264-0.778c-16.413-0.048-29.71-12.951-29.772-28.89l-1.251-320.62c-0.048-12.446 10.348-22.549 23.164-22.512l276.61 0.807c12.293 0.036 22.222 9.755 22.16 21.693z"
              fill="none"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="5"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 42.836 -17.59)">
            <path
              d="m0 0 0.859-165.03 252.3-0.301 1.926 157.12c0.189 15.475-10.33 28.152-23.396 28.194l-214.3 0.687c-9.637 0.031-17.447-9.251-17.387-20.666"
              fill="#eef6fc"
            />
            <path
              d="m0 0 0.859-165.03 252.3-0.301 1.926 157.12c0.189 15.475-10.33 28.152-23.396 28.194l-214.3 0.687c-9.637 0.031-17.447-9.251-17.387-20.666z"
              fill="none"
              stroke="#eef6fc"
              stroke-miterlimit="10"
              stroke-width="5"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 39.8 -29.068)">
            <path d="m0 0v-50l273.26 1.184 0.742 48.627z" fill="#eef6fc" />
            <path
              d="m0 0v-50l273.26 1.184 0.742 48.627z"
              fill="none"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="10"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 36.318 82.844)">
            <path
              d="M 0,0 C 0,13.579 11.335,24.585 25.318,24.585 39.3,24.585 50.636,13.579 50.636,0 50.636,-13.578 39.3,-24.585 25.318,-24.585 11.335,-24.585 0,-13.578 0,0"
              fill="#eef6fc"
            />
            <path
              d="m0 0c0 13.579 11.335 24.585 25.318 24.585 13.982 0 25.318-11.006 25.318-24.585 0-13.578-11.336-24.585-25.318-24.585-13.983 0-25.318 11.007-25.318 24.585z"
              fill="none"
              stroke="#eef6fc"
              stroke-miterlimit="10"
              stroke-width="5"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 122.65 82.844)">
            <path
              d="M 0,0 C 0,13.579 11.335,24.585 25.317,24.585 39.3,24.585 50.635,13.579 50.635,0 50.635,-13.578 39.3,-24.585 25.317,-24.585 11.335,-24.585 0,-13.578 0,0"
              fill="#eef6fc"
            />
            <path
              d="m0 0c0 13.579 11.335 24.585 25.317 24.585 13.983 0 25.318-11.006 25.318-24.585 0-13.578-11.335-24.585-25.318-24.585-13.982 0-25.317 11.007-25.317 24.585z"
              fill="none"
              stroke="#eef6fc"
              stroke-miterlimit="10"
              stroke-width="5"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 31.19 47.093)">
            <path
              d="m0 0s104.64-88.161 323.14-8.23l1.636-33.708s-211.42-32.639-326 5.487z"
              fill="#eef6fc"
            />
            <path
              d="m0 0s104.64-88.161 323.14-8.23l1.636-33.708s-211.42-32.639-326 5.487z"
              fill="none"
              stroke="#eef6fc"
              stroke-miterlimit="10"
              stroke-width="5"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 87.571 -12.533)">
            <path
              d="m0 0-1.594-163"
              fill="none"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="10"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 57.009 38.303)">
            <path
              d="m0 0 52.387 54.018"
              fill="none"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="10"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 103.06 37.809)">
            <path
              d="m0 0 52.387 54.019"
              fill="none"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="10"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 40.003 95.803)">
            <path
              d="m0 0 0.07-9.159c0.025-3.248 2.743-5.868 6.089-5.868h27.218c3.384 0 6.118 2.676 6.088 5.964-0.045 4.909-0.156 11.292-0.432 12.764"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="10"
              fill="#2374ab"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 121.93 95.956)">
            <path
              d="m0 0 0.075-9.784c0.022-2.902 2.451-5.243 5.44-5.243h28.516c3.021 0 5.464 2.385 5.44 5.32-0.041 4.977-0.15 11.87-0.438 13.408"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="10"
              fill="#2374ab"
            />
          </g>
          <g transform="matrix(.35278 0 0 -.35278 65.918 -34.849)">
            <path
              d="m0 0-0.163 6.198c-0.08 3.015 2.342 5.502 5.358 5.503l100.89 0.033c2.962 1e-3 5.363-2.399 5.364-5.36l1e-3 -3.911"
              stroke="#2374ab"
              stroke-miterlimit="10"
              stroke-width="10"
              fill="#2374ab"
            />
          </g>
        </g>
      </svg>
    </div>
    <div class="secondary tt-texture--icons">
      <v-container class="d-flex align-center pa-6">
        <div class="flex-grow-1">
          <h1 class="text-h5 font-weight-medium">
            {{ $t('home.welcome') }} Transit&nbsp;Tracker
          </h1>
          <h2 class="text-subtitle-1">
            {{ $t('home.version') }} {{ version }}
          </h2>
          <v-btn icon color="black" href="https://twitter.com/ttrackerca">
            <v-icon>mdi-twitter</v-icon>
          </v-btn>
          <v-btn
            icon
            color="black"
            href="http://github.com/felixinx/transit-tracker"
          >
            <v-icon>mdi-github</v-icon>
          </v-btn>
        </div>
        <img
          src="/img/logo.svg"
          alt="Logo Transit Tracker"
          height="75px"
          class="welcome-logo ml-4"
        />
      </v-container>
    </div>
    <v-container>
      <v-row>
        <v-col cols="12">
          <v-card v-if="activeAgencies.length" class="mt-4">
            <v-card-title>
              <span class="flex-grow-1">
                {{ totalCount }} {{ $t('home.vehicleTotal') }}
              </span>
              <v-btn
                color="primary"
                :fab="$vuetify.breakpoint.smAndDown"
                :small="$vuetify.breakpoint.smAndDown"
                elevation="0"
                :title="$t('home.downloadTitle')"
                @click="downloadDialog = true"
              >
                <v-icon :left="$vuetify.breakpoint.mdAndUp">
                  mdi-download
                </v-icon>
                <span class="d-none d-md-block">{{ $t('home.download') }}</span>
              </v-btn>
            </v-card-title>
            <v-card-text>
              <v-row>
                <v-col
                  v-for="agency in activeAgencies"
                  :key="agency.slug"
                  cols="12"
                  md="4"
                >
                  <v-card
                    elevation="0"
                    width="100%"
                    height="100%"
                    :color="`${agency.color}26`"
                    :loading="!(agency.slug in vehicleCounts)"
                    class="tt-agencies-card"
                    rounded="lg"
                  >
                    <v-card-text class="px-3 py-2 tt-agencies-card__text">
                      <b>{{ agency.name }}</b>
                      <br />
                      <span v-if="agency.slug in vehicleCounts">
                        {{ vehicleCounts[agency.slug] }} vehicles &bull;
                      </span>
                      <timeago
                        :datetime="(times[agency.slug] || 0) * 1000"
                        :auto-update="30"
                        :locale="lang"
                      />
                    </v-card-text>
                    <div
                      class="tt-agencies-card__clip-path"
                      :style="{ backgroundColor: agency.color }"
                    ></div>
                  </v-card>
                </v-col>
              </v-row>
            </v-card-text>
          </v-card>
          <v-card v-else>
            <v-card-text class="d-flex flex-column align-center">
              <v-icon size="100" color="primary">mdi-map-plus</v-icon>
              <div class="text-h6 text-center my-2">
                {{ $t('home.emptyTitle') }}
              </div>
              <div class="text-subtitle1 text-center mb-6">
                {{ $t('home.emptyBody') }}
              </div>
              <v-btn large color="primary" :to="localePath('/')">
                {{ $t('home.emptyButton') }}
              </v-btn>
            </v-card-text>
          </v-card>
        </v-col>
        <v-col v-if="region.name" cols="12" md="6">
          <v-card dark>
            <!-- eslint-disable -->
            <v-card-title v-html="region.infoTitle"></v-card-title>
            <v-card-text v-html="region.infoBody"></v-card-text>
            <!-- eslint-enable -->
            <v-img
              v-if="region.image"
              height="150"
              :src="region.image"
              gradient="to top, transparent 0%, rgba(0,73,123,1) 100%"
            ></v-img>
          </v-card>
        </v-col>
        <v-col v-if="region.name" cols="12" md="6">
          <v-card>
            <v-card-title>{{ $t('home.creditsTitle') }}</v-card-title>
            <!-- eslint-disable -->
            <v-card-text v-html="region.credits"></v-card-text>
            <!-- eslint-enable -->
          </v-card>
        </v-col>
      </v-row>
    </v-container>
    <DownloadDialog v-model="downloadDialog" />
  </div>
</template>

<script>
import Vue from 'vue'
import VueTimeago from 'vue-timeago'

Vue.use(VueTimeago, {
  locales: {
    en: require('date-fns/locale/en'),
    fr: require('date-fns/locale/fr'),
  },
})

export default {
  asyncData({ params }) {
    return { regionSlug: params.region }
  },
  data: () => ({
    downloadDialog: false,
  }),
  head() {
    return {
      title: this.region.name,
      meta: [
        {
          hid: 'description',
          name: 'description',
          content: this.region.metaDescription,
        },
      ],
    }
  },
  computed: {
    activeAgencies() {
      const activeAgencies = this.$store.state.settings.activeAgencies

      return Object.values(this.$store.state.agencies.data).filter(
        ({ slug, regions }) => {
          if (regions.includes('*')) {
            return true
          }
          return (
            activeAgencies.includes(slug) && regions.includes(this.regionSlug)
          )
        }
      )
    },
    darkMode() {
      return this.$vuetify.theme.dark
    },
    region() {
      return (
        this.$store.state.regions.data[this.regionSlug] || {
          agencies: [],
        }
      )
    },
    lang() {
      return this.$i18n.locale
    },
    vehicleCounts() {
      return this.$store.getters['vehicles/counts']
    },
    version() {
      return process.env.version
    },
    totalCount() {
      let total = 0
      Object.values(this.vehicleCounts).forEach((count) => {
        total += count
      })
      return total
    },
    times() {
      return this.$store.state.agencies.times
    },
  },
}
</script>

<style lang="scss">
.tt-agencies-card {
  overflow: clip;

  &__clip-path {
    height: 100%;
    width: 100%;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    position: absolute;
    clip-path: polygon(85% 0, 101% -1%, 101% 101%, 95% 100%);
  }

  &__text {
    height: 100%;
    max-width: 90%;
  }
}

.tt-illustration {
  svg {
    position: fixed;
    left: -15px;
    bottom: 20px;
    height: 300px;
    transform: rotate(12deg);
    opacity: 0.25;
  }

  overflow: hidden;
}
</style>
